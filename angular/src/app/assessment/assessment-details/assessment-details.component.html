<div *ngIf="!isLoading">
    <div style="width: 80%" class="px-4">
        <div>
            <div>
                <h1 class="d-inline">
                    {{ assessment.name }}
                </h1>
                <fa-icon
                    (click)="openModal(assessmentSetting)"
                    style="font-size: 1.75em; cursor: pointer"
                    class="text-secondary"
                    [icon]="faCog"
                ></fa-icon>

                <button
                    (click)="openModal(content)"
                    class="btn btn-primary float-right"
                >
                    Upload Script
                </button>
            </div>
            <div>
                <mat-form-field appearance="standard" style="width: 78%">
                    <mat-label>Filter</mat-label>
                    <input
                        matInput
                        type="text"
                        (keyup)="filterValue($event)"
                        class="d-inline-block"
                        placeholder="enter student name, student id or status"
                    />
                </mat-form-field>

                <select
                    class="form-select my-2 d-inline-block"
                    style="width: 20%; margin-left: 1rem"
                    name="markingSettings"
                    id="markingSettingSelect"
                >
                    <option
                        *ngFor="let setting of markingSettings"
                        value="setting"
                        [selected]="assessment.marking_setting == setting"
                    >
                        {{ setting.replaceAll("_", " ") | titlecase }}
                    </option>
                </select>
            </div>
        </div>
        <div
            id="table-container"
            style="max-height: 75vh; overflow: auto"
            class="shadow"
        >
            <table
                mat-table
                [dataSource]="answerScripts"
                class="mat-table w-100"
            >
                <ng-container matColumnDef="studentName">
                    <th mat-header-cell *matHeaderCellDef>Student Name</th>
                    <td mat-cell *matCellDef="let answer">
                        {{ answer.student_name }}
                    </td>
                </ng-container>
                <ng-container matColumnDef="studentId">
                    <th mat-header-cell *matHeaderCellDef>Student ID</th>
                    <td mat-cell *matCellDef="let answer">
                        {{ answer.student_id }}
                    </td>
                </ng-container>
                <ng-container matColumnDef="lastUpdate">
                    <th mat-header-cell *matHeaderCellDef>Last Update</th>
                    <td mat-cell *matCellDef="let answer">
                        {{ answer.date_updated | date: "dd/MM/yyyy, hh:mm a" }}
                    </td>
                </ng-container>
                <ng-container matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef>Status</th>
                    <td mat-cell *matCellDef="let answer">
                        <span
                            class="rounded-pill py-1 px-2 text-white"
                            [class]="{
                                'bg-primary': answer.status === 'In Progress',
                                'bg-secondary': answer.status === 'Not Started',
                                'bg-success': answer.status === 'Finished'
                            }"
                        >
                            {{ answer.status }}
                        </span>
                    </td>
                </ng-container>
                <ng-container matColumnDef="marks">
                    <th mat-header-cell *matHeaderCellDef>Marks</th>
                    <td mat-cell *matCellDef="let answer">
                        {{
                            answer.marks[markerIndex].totalMark
                                ? answer.marks[markerIndex].totalMark
                                : "-"
                        }}
                    </td>
                </ng-container>

                <tr
                    mat-header-row
                    *matHeaderRowDef="displayedColumns; sticky: true"
                    class="bg-primary"
                ></tr>
                <tr
                    mat-row
                    *matRowDef="let row; columns: displayedColumns"
                    [ngClass]="{ selected: selection.selected[0] === row }"
                    (click)="onRowSelect(row)"
                ></tr>
            </table>
        </div>
    </div>
    <div id="sideNav" class="bg-white p-3" style="width: 20%">
        <div id="assessmentBriefInfo">
            <h4>Your Progress</h4>
            <p>
                <ngb-progressbar
                    type="primary"
                    [value]="calculateProgress()"
                ></ngb-progressbar>
            </p>
            <small class="text-end d-block"
                >{{ finished }}/{{ answerScripts.data.length }}</small
            >
        </div>
        <div *ngIf="selection.selected.length > 0" class="my-4">
            <div id="selectedAnswerScriptInfo">
                <h4>Marks</h4>
                <div *ngIf="assessment.type === 'essay_based'">
                    <div
                        *ngFor="
                            let c of assessment.rubrics.criterion;
                            let i = index
                        "
                        class="row my-2"
                    >
                        <div class="col">
                            {{ c.title | titlecase }}
                        </div>
                        <div class="col">
                            {{
                                selection.selected[0].marks[markerIndex]
                                    .distribution[i].marksAwarded
                                    ? (selection.selected[0].marks[markerIndex]
                                          .distribution[i].marksAwarded *
                                          c.totalMarks) /
                                      100
                                    : "-"
                            }}
                        </div>
                    </div>
                </div>

                <div class="row mt-4">
                    <div class="col">
                        <h5>Total Mark</h5>
                    </div>
                    <div class="col">
                        <p>
                            {{
                                selection.selected[0].marks[markerIndex]
                                    .totalMark
                            }}
                        </p>
                    </div>
                </div>

                <!-- {{assessment.rubrics.criterion | json}} -->
                <!-- <span *ngFor=""></span> -->
            </div>
            <!-- {{ selection.selected[0].marks[markerIndex] | json }} -->
        </div>

        <div class="position-absolute" style="bottom: 0; left: 0; right: 0">
            <div>
                <a (click)="downloadGradebook()" class="btn btn-link d-block"
                    >Gradebook Export</a
                >
            </div>
            <a
                *ngIf="selection.selected.length > 0"
                routerLink="/marking/{{ selection.selected[0].id }}"
                class="btn btn-primary d-block"
                >Start Marking</a
            >
        </div>
    </div>
</div>

<!-- Model for upload script -->
<ng-template #content let-modal>
    <div class="modal-header">
        <h4 class="modal-title">Upload Script</h4>
        <button
            type="button"
            class="btn-close"
            aria-label="Close"
            (click)="modal.dismiss('Cross click')"
        ></button>
    </div>
    <div class="modal-body">
        <small>File types accepted: CSV, ZIP, DOC, DOCX, and PDF.</small>
        <div
            style="height: 250px; border: 2px dashed #4277ff"
            class="d-flex flex-column align-items-center justify-content-center my-4"
        >
            <fa-icon
                [icon]="faUpload"
                class="text-primary"
                style="font-size: xxx-large"
            ></fa-icon>
            <input
                type="file"
                id="fileInput"
                class="d-none"
                accept=".pdf, .csv, .doc, .docx, .zip"
                (change)="onFileChange($event.target.files)"
            />
            <button
                class="btn btn-outline-primary my-2"
                onclick="document.getElementById('fileInput').click()"
            >
                Choose file
            </button>
            <p *ngIf="!isSubmitDisabled">{{ uploadedFile.name }}</p>
        </div>
    </div>
    <div class="modal-footer">
        <button
            [disabled]="isSubmitDisabled"
            type="submit"
            class="btn btn-primary"
            (click)="bulkUpload()"
        >
            Submit
        </button>
    </div>
</ng-template>

<!-- Edit Assessment Modal -->
<ng-template #assessmentSetting let-modal>
    <div class="modal-header">
        <h4 class="modal-title">Settings</h4>
        <button
            type="button"
            class="btn-close"
            aria-label="Close"
            (click)="modal.dismiss('Cross click')"
        ></button>
    </div>
    <div class="modal-body">
        <div class="form-group">
            <label for="assessmentName">Assessment Name</label>
            <input
                type="text"
                class="form-control"
                id="assessmentName"
                [(ngModel)]="newAssessmentName"
            />
        </div>
        <div class="form-group">
            <label for="assessmentType">Assessment Type</label>
            <select
                class="form-select"
                name="assessmentTypes"
                id="assessmentTypes"
            >
                <option
                    *ngFor="let type of assessmentTypes"
                    [value]="type"
                    [selected]="type === assessment.type ? true : false"
                >
                    {{ type }}
                </option>
            </select>
        </div>
        <div class="form-group">
            <label for="markingSetting">Default Marking Setting</label>
            <select
                class="form-select"
                name="markingSetting"
                id="markingSetting"
            >
                <option
                    *ngFor="let setting of markingSettings"
                    [value]="setting"
                    [selected]="
                        setting == assessment.marking_settings ? true : false
                    "
                >
                    {{ setting }}
                </option>
            </select>
        </div>
        <div class="row">
            <div class="form-group col">
                <label for="rubrics">Rubrics</label>
                <button
                    (click)="openModal(editRubrics, { size: 'xl' })"
                    class="btn btn-outline-primary btn-sm d-inline-block ml-4"
                >
                    Edit Rubrics
                </button>
            </div>
            <div class="form-group col">
                <label for="rubrics">Questions</label>
                <button
                    (click)="openModal(editQuestions, { size: 'xl' })"
                    class="btn btn-outline-primary btn-sm d-inline-block ml-4"
                >
                    Edit Questions
                </button>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <button
            class="btn btn-danger"
            (click)="openModal(deleteConfirmation, {})"
        >
            Delete Assessment
        </button>
        <button (click)="onSave()" class="btn btn-primary">Save Changes</button>
    </div>
</ng-template>

<!-- * Edit Rubrics Modal -->
<ng-template let-modal #editRubrics>
    <div class="modal-header">
        <h4 class="modal-title">Rubrics</h4>
        <button
            type="button"
            class="btn-close"
            aria-label="Close"
            (click)="modal.dismiss('Cross click')"
        ></button>
    </div>
    <div class="modal-body">
        <app-rubrics-input
            #rubricsInput
            [isEditingMode]="true"
            [(rubrics)]="assessment.rubrics"
        ></app-rubrics-input>
    </div>
    <div class="modal-footer">
        <button class="btn btn-secondary text-white" (click)="modal.close()">
            Cancel
        </button>
        <button
            class="btn btn-primary"
            (click)="saveEditedRubrics(rubricsInput, modal)"
        >
            Confirm
        </button>
    </div>
</ng-template>

<ng-template let-modal #deleteConfirmation>
    <div class="modal-header">
        <h4 class="modal-title">Warning!</h4>
        <button
            type="button"
            class="btn-close"
            aria-label="Close"
            (click)="modal.dismiss('Cross click')"
        ></button>
    </div>
    <div class="modal-body">
        <p>Are you sure you want to delete this assessment?</p>
    </div>
    <div class="modal-footer">
        <div>
            <button
                (click)="modal.dismiss('Cross click')"
                class="btn btn-outline-primary"
            >
                Cancel
            </button>
            <button
                (click)="deleteAssessment(assessment.id)"
                class="btn btn-danger"
            >
                Delete
            </button>
        </div>
    </div>
</ng-template>

<!-- * Edit Questions Modal -->
<ng-template let-modal #editQuestions>
    <div class="modal-header">
        <h4 class="modal-title">Question</h4>
        <button
            type="button"
            class="btn-close"
            aria-label="Close"
            (click)="modal.dismiss('Cross click')"
        ></button>
    </div>
    <div class="modal-body">
        <app-question-input
            #questionsInput
            [(questions)]="assessment.questions"
            [isEditingMode]="true"
        >
        </app-question-input>
    </div>
    <div class="modal-footer">
        <button class="btn btn-secondary text-white" (click)="modal.close()">
            Cancel
        </button>
        <button
            class="btn btn-primary"
            (click)="saveEditedQuestions(questionsInput, modal)"
        >
            Confirm
        </button>
    </div>
</ng-template>

<mat-spinner
    *ngIf="isLoading"
    [strokeWidth]="2"
    [diameter]="150"
    class="mx-auto mt-5"
></mat-spinner>
